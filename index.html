<!doctype html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NSJ Chat Button</title>
    <style>
      :root {
        --nsj-z-overlay: 9998;
        --nsj-z-frame: 9999;
        --nsj-z-btn: 10000;
      }
      html,
      body {
        margin: 0;
        padding: 0;
        background: transparent;
      }
      #nsjOverlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.28);
        backdrop-filter: blur(6px);
        z-index: var(--nsj-z-overlay);
        display: none;
        opacity: 0;
        transition: opacity 0.22s ease;
      }
      #nsjOverlay.open {
        display: block;
        opacity: 1;
      }
      #nsjFrame {
        position: fixed;
        right: 18px;
        bottom: 86px;
        width: 420px;
        height: 620px;
        max-width: calc(100vw - 36px);
        max-height: calc(100vh - 120px);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 18px;
        box-shadow: 0 30px 90px rgba(0, 0, 0, 0.45);
        z-index: var(--nsj-z-frame);
        display: none;
        opacity: 0;
        transform: translateY(14px) scale(0.98);
        transition: opacity 0.22s ease, transform 0.22s ease;
        background: transparent;
      }
      #nsjFrame.open {
        display: block;
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      #nsjButton {
        position: fixed;
        right: 18px;
        bottom: 18px;
        width: 54px;
        height: 54px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        z-index: var(--nsj-z-btn);
        transition: transform 0.18s ease, filter 0.18s ease;
        user-select: none;
      }
      #nsjButton:hover {
        transform: scale(1.05);
        filter: brightness(1.05);
      }
      #nsjButton:active {
        transform: scale(0.98);
      }
      @media (max-width: 480px) {
        #nsjFrame {
          right: 10px;
          bottom: 78px;
          width: calc(100vw - 20px);
          height: min(680px, calc(100vh - 110px));
        }
        #nsjButton {
          right: 12px;
          bottom: 12px;
        }
      }
    </style>
  </head>

  <body>
    <div id="nsjOverlay" aria-hidden="true"></div>

    <button id="nsjButton" type="button" aria-label="เปิดแชทน้องใส่ใจ">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path
          d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10Z"
          stroke="currentColor"
          stroke-width="2"
          stroke-linejoin="round"
        />
      </svg>
    </button>

    <iframe id="nsjFrame" title="น้องใส่ใจ" frameborder="0" allow="clipboard-read; clipboard-write"></iframe>

    <script>
      // =========================
      // CONFIG (แก้แค่นี้)
      // =========================
      const CONFIG = {
        baseUrl: "https://mfec_nongsaijai.mfec.co.th",
        tokenKey: "nsj_access_token",
        iframeOrigin: "https://mfec_nongsaijai.mfec.co.th",
      };

      const btn = document.getElementById("nsjButton");
      const frame = document.getElementById("nsjFrame");
      const overlay = document.getElementById("nsjOverlay");

      let isOpen = false;
      let embedReady = false;
      let pendingTokenToSend = null;
      let lastSentToken = null;

      // ตั้ง src ของ iframe (คงที่)
      frame.src = CONFIG.baseUrl + "/chat/embed";

      // -------------------------
      // Token handling (parent)
      // -------------------------
      function pickToken() {
        const hash = new URLSearchParams((window.location.hash || "").replace(/^#/, ""));
        const query = new URLSearchParams(window.location.search || "");

        const hashToken = hash.get("access_token") || hash.get("token") || hash.get("t");
        const queryToken = query.get("access_token") || query.get("token") || query.get("t");

        const stored = localStorage.getItem(CONFIG.tokenKey);
        const token = (hashToken || queryToken || stored || "").trim();

        if (token && token !== stored) {
          try {
            localStorage.setItem(CONFIG.tokenKey, token);
          } catch {}
        }

        return token;
      }

      // -------------------------
      // postMessage
      // -------------------------
      function sendTokenToIframe(token) {
        if (!token || token.length < 10) return;
        if (!frame.contentWindow) return;

        // กันส่งซ้ำถ้า token เดิม
        if (token === lastSentToken) return;

        try {
          frame.contentWindow.postMessage({ type: "NSJ_TOKEN", token }, CONFIG.iframeOrigin);
          lastSentToken = token;
        } catch (e) {
          console.warn("postMessage failed:", e);
        }
      }

      // -------------------------
      // UI open/close
      // -------------------------
      function openChat() {
        const token = pickToken();
        if (!token || token.length < 10) {
          alert("ไม่พบ Token กรุณาเข้าสู่ระบบก่อน");
          return;
        }

        isOpen = true;
        pendingTokenToSend = token;

        overlay.style.display = "block";
        frame.style.display = "block";

        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            overlay.classList.add("open");
            frame.classList.add("open");
          });
        });

        // ✅ ไม่ส่งทันทีแบบสุ่มเวลาอีกแล้ว
        // รอ NSJ_EMBED_READY แล้วค่อยส่งเพื่อให้ exchangeToken/cookie/bearer-fallback ทำงานชัวร์
        if (embedReady) {
          sendTokenToIframe(pendingTokenToSend);
        }
      }

      function closeChat() {
        isOpen = false;
        pendingTokenToSend = null;

        overlay.classList.remove("open");
        frame.classList.remove("open");

        setTimeout(() => {
          if (!isOpen) {
            overlay.style.display = "none";
            frame.style.display = "none";
          }
        }, 220);
      }

      function toggleChat() {
        if (isOpen) closeChat();
        else openChat();
      }

      // -------------------------
      // Event bindings
      // -------------------------
      btn.addEventListener("click", toggleChat);
      overlay.addEventListener("click", closeChat);

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && isOpen) closeChat();
      });

      // รับ message จาก iframe
      window.addEventListener("message", (e) => {
        // security: รับเฉพาะจาก iframe origin
        if (e.origin !== CONFIG.iframeOrigin) return;

        const data = e.data || {};

        // ✅ iframe พร้อมแล้ว
        if (data.type === "NSJ_EMBED_READY") {
          embedReady = true;

          // ถ้าเปิดอยู่แล้วและมี token ค้างอยู่ -> ส่งเลย
          if (isOpen && pendingTokenToSend) {
            sendTokenToIframe(pendingTokenToSend);
          }
          return;
        }

        if (data.type === "NSJ_AUTH_OK") {
          // auth สำเร็จ (cookie-first หรือ bearer-fallback อยู่ฝั่ง iframe)
          return;
        }

        if (data.type === "NSJ_AUTH_ERROR") {
          console.warn("NSJ auth error:", data.data);
          // จะปิด chat ก็ได้ ถ้าต้องการ
          // closeChat();
          return;
        }

        // เปิด admin จากใน widget
        if (data.type === "NSJ_OPEN_ADMIN" && data.url) {
          window.location.href = data.url;
        }
      });
    </script>
  </body>
</html>
